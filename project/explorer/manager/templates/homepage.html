{% extends 'templates/master.html' %}
{% load static %}



	<title>{% block title %}Explore Data to Gain Insight{% endblock %}</title>

	{% block body %}
  <div class="row">



		{% if intro_message|length < 1 %}
			{% if username == admin%}
				<a href="/config/main" role="button" class="btn btn-lg btn-danger btn-block">Start Configuration<br><small>Better sooner than later</a>
			{% else %}
				<h3>System not configured yet. Please keep putting pressure on admin.</h3>
			{% endif %}
		{% else %}
			{% if user.username == "admin" %}
					<a href="/add/user" role="button" class="btn btn-lg btn-warning btn-block">Add Users</a>
					<h5>{{user_count_message}}</h5>
					<div>sudo groupadd django_users</div>
					<div>sudo adduser django_admin
						<div class="">
								<small>This user can create basic system users</small>
						</div>
						<div class="">
								<small>django_admin ALL = NOPASSWD:adduser</small>
						</div>

					</div>
					<p>add users through tool interface</p>
			{% else %}
				{% if data_points < 1 %}
					<button type="button" class="btn btn-lg btn-color-dark btn-block" data-toggle="modal" data-target="#fileUploadModal">Upload Data First</button>
				{%endif%}
				<div id="data_point_svg">

				</div>




				<div class="modal" id="selectStepFromDataPointModal" tabindex="-1" role="dialog">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title">Select Analysis Step</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body">
				        <div>
				          <input class="form-control" type="text" id="select_step_input_dp" value="" onkeyup="filterStepSelectDP()">
				          <select class="form-control" id="select_step_select_dp" onchange="showStepDescriptionDP()">
				          </select>
				          <div id='step_description_dp'>
				          </div>
				        </div>
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-primary" onclick="stepSelectedDP()">Select</button>
				        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				      </div>
				    </div>
				  </div>
				</div>


			{%endif%}
		{%endif%}






	{% endblock %}




	{% block afterbody %}
	<script type="text/javascript">
			var data_points = {{data_points | safe}}

			function filterStepSelectDP() {
				var selected_node = right_click_data_point
				last_output_category = data_points.filter(x=>x.pk==selected_node)[0].fields.major_types

		    var filteredSteps = steps.filter(x=>x.fields.input_major_data_category==last_output_category)
		    var typed = document.getElementById('select_step_input_dp').value.trim()
		    if (typed.length > 0) {
		      filteredSteps = filteredSteps.filter(x=>x.fields.short_name.includes(typed) | x.fields.description.includes(typed))
		    }

		    d3.select('#select_step_select_dp').selectAll('option').remove()
		    d3.select('#select_step_select_dp').selectAll('option').data(filteredSteps).enter()
		      .append('option').text(function(d,i){return d.fields.short_name}).attr('value', function(d){return d.pk})
		    showStepDescriptionDP()
		  }


			function showStepDescriptionDP() {
				d3.select('#step_description_dp').select('div').remove()
				var select = document.getElementById('select_step_select_dp')
				var curr_step = steps.filter(x=>x.pk==select.options[select.selectedIndex].value)[0].fields
				var div = d3.select('#step_description_dp').append('div').attr('class', 'row')
				div.append('div').attr('class', 'col-md-2').html('<b>Accepts</b><br>' + curr_step.input_major_data_category)
				div.append('div').attr('class', 'col-md-8').html(curr_step.description)
				div.append('div').attr('class', 'col-md-2').html('<b>Outputs</b><br>' + curr_step.output_major_data_category)
			}


			function stepSelectedDP() {
				var select = document.getElementById('select_step_select_dp')
				$('#selectStepFromDataPointModal').modal('hide')
				var selectedStep = select.options[select.selectedIndex].value
				submitAnalysisRequest(selectedStep)
			}


			function submitAnalysisRequest(step_id) {
			  var formData = new FormData();

				formData.append('step_id', step_id)
				formData.append('reference_data_points', right_click_data_point)

			  var xhr = new XMLHttpRequest()
			  xhr.open('POST', '/new/step/', true);


			  xhr.onload = function () {
			    if (xhr.status === 200) {
			      alert('New step created')
						reDrawTreeWithNewDataPoints()
			    } else {
			      alert('Sorry, there is something wrong. Maybe the server is down, or you lost connection.');
			    }
			  };

				xhr.send(formData);

			}


			function reDrawTreeWithNewDataPoints() {
				d3.json('/get/data_points/').on('load', function(data) {
					data_points = JSON.parse(data)
					createTree(data_points)

			}).mimeType("text/csv")
    		.get()


			}


			function createTree(data_points){
				var simplified = data_points.map(function (x){
					var anc=x.fields.ancestry.split(',')
					return {'id':String(x.pk), 'parent':anc[anc.length-1], 'ancestry':anc, 'category':x.major_types}
				}).sort(compareLevels)

				var roots = list_to_tree(simplified)
				d3.select('#data_point_svg').selectAll('svg').remove()
				for (var index in roots) {
						main('svg_'+index, roots[index])
				}

			}


			function list_to_tree(list) {
			    var map = {}, node, roots = [], i;
			    for (i = 0; i < list.length; i += 1) {
			        map[list[i].id] = i; // initialize the map
			        list[i].children = []; // initialize the children
			    }
			    for (i = 0; i < list.length; i += 1) {
			        node = list[i];
			        if (node.parent.length !== 0) {
			            // if you have dangling branches check that map[node.parentId] exists
			            list[map[node.parent]].children.push(node);
			        } else {
			            roots.push(node);
			        }
			    }
			    return roots;
			}


			function compareLevels(a, b) {
			  return a.ancestry.length - b.ancestry.legend;
			}





	</script>
	<style>

.node {
  cursor: pointer;
}

.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.node text {
  font: 16px sans-serif;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">
	var right_click_data_point = ''

	function main(svg_id, data) {

		var margin = {top: 20, right: 20, bottom: 20, left: 20},
		    width = 800 - margin.right - margin.left,
		    height = 300 - margin.top - margin.bottom;

		var i = 0,
		    duration = 750,
		    root;

		var tree = d3.layout.tree()
		    .size([height, width]);

		var diagonal = d3.svg.diagonal()
		    .projection(function(d) { return [d.y, d.x]; });

		d3.select("#data_point_svg").select('#'+svg_id).remove()
		var svg = d3.select("#data_point_svg").append("svg").attr('id', svg_id)
		    .attr("width", width + margin.right + margin.left)
		    .attr("height", height + margin.top + margin.bottom)
		  .append("g")
		    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		function drawTree(flare) {

		  root = flare;
		  root.x0 = height / 2;
		  root.y0 = 0;

		  function collapse(d) {
		    if (d.children) {
		      d._children = d.children;
		      d._children.forEach(collapse);
		      d.children = null;
		    }
		  }

		  //root.children.forEach(collapse);
		  update(root);
		}

		d3.select(self.frameElement).style("height", "300px");

		function update(source) {

		  // Compute the new tree layout.
		  var nodes = tree.nodes(root).reverse(),
		      links = tree.links(nodes);

		  // Normalize for fixed-depth.
		  //nodes.forEach(function(d) { d.y = d.depth * 80; });

		  // Update the nodes…
		  var node = svg.selectAll("g.node")
		      .data(nodes, function(d) { return d.id || (d.id = ++i); });

		  // Enter any new nodes at the parent's previous position.
		  var nodeEnter = node.enter().append("g")
		      .attr("class", "node")
		      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
		      .on("click", click).on('contextmenu', function(){
							right_click_data_point = this.getElementsByTagName('hidden')[0].getAttribute('value')
							d3.event.preventDefault();
							menu(d3.mouse(this)[0], d3.mouse(this)[1]);
					});

		  nodeEnter.append("circle")
		      .attr("r", 1e-6)
		      .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

		  nodeEnter.append("text")
		      .attr("x", 0)
		      .attr("dy", ".35em")
		      .attr("text-anchor", 'middle')
		      .text(function(d) { return d.id; })
		      .style("fill-opacity", 1e-6);

			nodeEnter.append("hidden")
		      .attr('value', function(d) { return d.id; })

		  // Transition nodes to their new position.
		  var nodeUpdate = node.transition()
		      .duration(duration)
		      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

		  nodeUpdate.select("circle")
		      .attr("r", 16)
		      .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

		  nodeUpdate.select("text")
		      .style("fill-opacity", 1);

		  // Transition exiting nodes to the parent's new position.
		  var nodeExit = node.exit().transition()
		      .duration(duration)
		      .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
		      .remove();

		  nodeExit.select("circle")
		      .attr("r", 1e-6);

		  nodeExit.select("text")
		      .style("fill-opacity", 1e-6);

		  // Update the links…
		  var link = svg.selectAll("path.link")
		      .data(links, function(d) { return d.target.id; });

		  // Enter any new links at the parent's previous position.
		  link.enter().insert("path", "g")
		      .attr("class", "link")
		      .attr("d", function(d) {
		        var o = {x: source.x0, y: source.y0};
		        return diagonal({source: o, target: o});
		      });

		  // Transition links to their new position.
		  link.transition()
		      .duration(duration)
		      .attr("d", diagonal);

		  // Transition exiting nodes to the parent's new position.
		  link.exit().transition()
		      .duration(duration)
		      .attr("d", function(d) {
		        var o = {x: source.x, y: source.y};
		        return diagonal({source: o, target: o});
		      })
		      .remove();

		  // Stash the old positions for transition.
		  nodes.forEach(function(d) {
		    d.x0 = d.x;
		    d.y0 = d.y;
		  });
		}

		// Toggle children on click.
		function click(d) {
		  if (d.children) {
		    d._children = d.children;
		    d.children = null;
		  } else {
		    d.children = d._children;
		    d._children = null;
		  }
		  update(d);
		}



	//////////////////
	////CONTEXT MENU


		function contextMenu() {
			var height,
					width,
					margin = 0.1, // fraction of width
					items = [],
					rescale = false,
					style = {
							'rect': {
									'mouseout': {
											'fill': 'rgb(244,244,244)',
											'stroke': 'white',
											'stroke-width': '1px'
									},
									'mouseover': {
											'fill': 'rgb(200,200,200)'
									}
							},
							'text': {
									'fill': 'steelblue',
									'font-size': '18'
							}
					};

			function menu(x, y) {
					d3.select('.context-menu').remove();
					scaleItems();

					// Draw the menu

						svg.append('g').attr('class', 'context-menu')
							.selectAll('tmp')
							.data(items).enter()
							.append('g').attr('class', 'menu-entry')
							.style({'cursor': 'pointer'})
							.on('mouseover', function(){
									d3.select(this).select('rect').style(style.rect.mouseover) })
							.on('mouseout', function(){
									d3.select(this).select('rect').style(style.rect.mouseout) })
							.on('click', function(){
									var selected = this.getElementsByTagName('text')[0].innerHTML
									if (selected == 'Add analysis step') {
										addAnalysisStepRequest()
									}
								 });

					d3.selectAll('.menu-entry')
							.append('rect')
							.attr('x', x)
							.attr('y', function(d, i){ return y + (i * height); })
							.attr('width', width)
							.attr('height', height)
							.style(style.rect.mouseout);

					d3.selectAll('.menu-entry')
							.append('text')
							.text(function(d){ return d; })
							.attr('x', x)
							.attr('y', function(d, i){ return y + (i * height); })
							.attr('dy', height - margin / 2)
							.attr('dx', margin)
							.style(style.text);

					// Other interactions
					d3.select('body')
							.on('click', function() {
									d3.select('.context-menu').remove();
							});

			}

			menu.items = function(e) {
					if (!arguments.length) return items;
					for (i in arguments) items.push(arguments[i]);
					rescale = true;
					return menu;
			}

			// Automatically set width, height, and margin;
			function scaleItems() {
					if (rescale) {
							svg.selectAll('tmp')
									.data(items).enter()
									.append('text')
									.text(function(d){ return d; })
									.style(style.text)
									.attr('x', -1000)
									.attr('y', -1000)
									.attr('class', 'tmp');
							var z = d3.selectAll('.tmp')[0]
												.map(function(x){ return x.getBBox(); });
							width = d3.max(z.map(function(x){ return x.width; }));
							margin = margin * width;
							width =  width + 2 * margin;
							height = d3.max(z.map(function(x){ return x.height + margin / 2; }));

							// cleanup
							d3.selectAll('.tmp').remove();
							rescale = false;
					}
			}

			return menu;
		}

		var menu = contextMenu().items('Add analysis step', 'Edit info', 'Download');




		drawTree(data)

	}


	createTree(data_points)


	function addAnalysisStepRequest() {
		//console.log(right_click_data_point);
		$('#selectStepFromDataPointModal').modal('show')
		filterStepSelectDP()
	}


</script>



	{% endblock %}
