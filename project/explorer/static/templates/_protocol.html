<div id="svg_area">

</div>
<head>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
</head>
<script>

  var svg_widht = 1000
  var svg_height = 500
  stepListOrg = {{steps|safe}}
  stepList = {{steps|safe}}

  var svg = svg_append('#svg_area',svg_height,svg_widht ,'lightgray')
  reDraw(stepList)
  function reDraw(circles) {
    d3.select('#svg_area').select('svg').remove()
    var svg = svg_append('#svg_area',svg_height,svg_widht ,'lightgray')

    for (var i = 0; i < circles.length; i++) {
      drawStepCircle(i, svg_widht/(circles.length+1)+svg_widht/(circles.length+1)*i+svg_widht/(circles.length+1)*.3, svg_widht/(circles.length+1)*.3)
    }

    function drawStepCircle(i, cx, r){
      if (i==(0)) {svg.append('rect').attr('x',svg_widht/(circles.length+1)-2*r).attr('y',svg_height/2-r).attr('height', 2*r).attr('width', r).style('fill', "AntiqueWhite")}
      circle_append(cx,svg_height/2,r,i,"ivory","main_","")
      circle_append(cx-r,svg_height/2,r/4,i,"lightblue","in_","")
      circle_append(cx+r,svg_height/2,r/4,i,"lightgreen","out_","modal_trigger()")
      add_arrow('#svg_area', cx-2*r ,svg_height/2, cx-1.5*r ,svg_height/2)
      if (i==(circles.length-1)) {add_delete_awesome('#svg_area', "far fa-trash-alt", cx, svg_height/2+r, "black")}
    }

    function circle_append(cx,cy,r,i,fill,id) {
      svg.append('circle').attr('id', id+i).attr('cx', cx).attr('cy', cy).attr('r', r).style('fill', fill).attr("onclick",onclick)
    }
    modifyLastOne(String(circles.length-1))

}
    function svg_append(select,height,width,background){
      return d3.select(select).append('svg').attr('height', height).attr('width', width).style('background-color', background)
    }
    function modifyLastOne(index) {
      modifyElement(index,"GoldenRod", "blue", "green")
      lastElement = stepList[stepList.length-1]
      lastCategory = lastElement.fields.output_major_data_category
      filteredSteps = stepListOrg.filter(x=>x.fields.input_major_data_category==lastCategory)
      filteredStepsSN = [];
      for (var i = 0; i < filteredSteps.length; i++) {filteredStepsSN.push(filteredSteps[i].fields.short_name)}}

    function modifyElement(i,mainFill, InFill, OutFill) {
      d3.select("#main_"+i).style("fill",mainFill)
      d3.select("#in_"+i).style("fill",InFill)
      d3.select("#out_"+i).style("fill",OutFill).attr("onclick","modal_trigger(this)")
    }
    function add_delete_awesome(select_id, font_class, x, y, color) {
      d3.select(select_id).select("svg").append("foreignObject").attr("id","delete_awesome").attr("x", x-5).attr("y", y)
        .append("xhtml:span").append("i").attr("class", font_class).style("color",color).attr("onclick","delete_step()");
    }
    function add_arrow(select_id,x1,y1,x2,y2) {
      d3.select(select_id).select("svg")
        .append("svg:defs").append("svg:marker").attr("class","arrow").attr("id", "triangle").attr("refX", 6).attr("refY", 6)
        .attr("markerWidth", 30).attr("markerHeight", 30).attr("markerUnits","userSpaceOnUse").attr("orient", "auto")
        .append("path").attr("d", "M 0 0 12 6 0 12 3 6").style("fill", "#034F84").style("position","relative").style("z-index",1)
      d3.select(select_id).select("svg").append("line").attr("x1",x1).attr("y1",y1).attr("x2",x2).attr("y2",y2)
        .attr("class","line").attr("stroke-width", 2).attr("stroke", "#034F84").attr("marker-end", "url(#triangle)").style("position","relative").style("z-index",1)
      }

    function delete_step() {
      stepList.pop()
      reDraw(stepList)
    }
    function modal_trigger() {
      $('#ModalCenter').modal('show');
      d3.select("#data_category_start").remove()
      data_category_dropdown("modalBody",filteredStepsSN)

    }
    function data_category_dropdown(id,data) {
      d3.select("#"+id)
          .append("select")
          .attr("id","data_category_start")
          .selectAll('option')
           .data(data).enter()
           .append('option')
           .attr("value",function (d) { ;return d; })
           .text(function (d) { return d; });
    }
    function append_step() {
      selected_value = d3.select("#data_category_start").node().value
      stepList.push(stepListOrg.filter(x=>x.fields.short_name==selected_value)[0])
      reDraw(stepList)
      $('#ModalCenter').modal('hide');
    }

    function search_step() {
      var new_data_list = []
      d3.select("#data_category_start").remove()
      for (var i = 0; i < filteredStepsSN.length; i++) {
        if (filteredStepsSN[i].includes(document.getElementById("search_step_input").value)) {
          new_data_list.push(filteredStepsSN[i])}
      }

     d3.select("#modalBody")
         .append("select")
         .attr("id","data_category_start")
         .selectAll('option')
          .data(new_data_list).enter()
          .append('option')
          .attr("value",function (d) { ;return d; })
          .text(function (d) { return d; });
       }


</script>
<div class="modal fade" id="ModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ModalTitle">Select Operation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <input type="search" class="form-control" id="search_step_input"  placeholder="Search Step" onchange="search_step()">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="append_step()">Add</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
